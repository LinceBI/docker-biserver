#!/bin/sh

set -eu
export LC_ALL=C

# shellcheck source=./set-utils.sh
. /usr/share/biserver/bin/set-utils.sh

########

# shellcheck disable=SC2034
{
	set -a

	INSTANCE_ID=$(getVar INSTANCE_ID "$(uname -n)")

	IS_EXPORTING=$(getVar IS_EXPORTING "false")

	HSQLDB_PORT=$(getVar HSQLDB_PORT "9001")
	KARAF_STARTPORT=$(getVar KARAF_STARTPORT "8801")
	KARAF_ENDPORT=$(getVar KARAF_ENDPORT "8899")
	OSGI_SERVICE_STARTPORT=$(getVar OSGI_SERVICE_STARTPORT "9050")
	OSGI_SERVICE_ENDPORT=$(getVar OSGI_SERVICE_ENDPORT "9149")

	FQSU_PROTOCOL=$(getVar FQSU_PROTOCOL "http")
	FQSU_DOMAIN=$(getVar FQSU_DOMAIN "localhost")
	FQSU_PORT=$(getVar FQSU_PORT "${TOMCAT_HTTP_PORT:?}")
	FQSU_ALT=$(getVar FQSU_ALT "")

	IS_PROXIED=$(getVar IS_PROXIED "false")
	PROXY_SCHEME=$(getVar PROXY_SCHEME "${FQSU_PROTOCOL:?}")
	PROXY_NAME=$(getVar PROXY_NAME "${FQSU_DOMAIN:?}")
	PROXY_PORT=$(getVar PROXY_PORT "${FQSU_PORT:?}")

	TOMCAT_HTTP_REDIRECT_PORT=$(getVar TOMCAT_HTTP_REDIRECT_PORT "8443")
	TOMCAT_HTTP_MAX_HTTP_HEADER_SIZE=$(getVar TOMCAT_HTTP_MAX_HTTP_HEADER_SIZE "65536")
	TOMCAT_AJP_REDIRECT_PORT=$(getVar TOMCAT_AJP_REDIRECT_PORT "8443")
	TOMCAT_AJP_PACKET_SIZE=$(getVar TOMCAT_AJP_PACKET_SIZE "8192")

	DEFAULT_ADMIN_PASSWORD=$(getPasswordVar DEFAULT_ADMIN_PASSWORD "")
	DEFAULT_NON_ADMIN_PASSWORD=$(getPasswordVar DEFAULT_NON_ADMIN_PASSWORD "${DEFAULT_ADMIN_PASSWORD:?}")

	INITIAL_ROLES=$(getVar INITIAL_ROLES "{}")
	INITIAL_USERS=$(getVar INITIAL_USERS "{}")

	AUDIT_ENTRY=$(getVar AUDIT_ENTRY "null")
	AUDIT_CLEAN_SCHEDULE=$(getVar AUDIT_CLEAN_SCHEDULE "0 15 0 ? * * *")
	AUDIT_CLEAN_MAX_RETENTION_DAYS=$(getVar AUDIT_CLEAN_MAX_RETENTION_DAYS "90")

	SESSION_TIMEOUT=$(getVar SESSION_TIMEOUT "120")
	COOKIE_SAMESITE=$(getVar COOKIE_SAMESITE "Lax")
	COOKIE_PARTITIONED=$(getVar COOKIE_PARTITIONED "false")

	CSRF_PROTECTION_ENABLED=$(getVar CSRF_PROTECTION_ENABLED "false")

	SSRF_PROTECTION_ENABLED=$(getVar SSRF_PROTECTION_ENABLED "false")

	CORS_REQUESTS_ALLOWED=$(getVar CORS_REQUESTS_ALLOWED "false")
	CORS_REQUESTS_ALLOWED_DOMAINS=$(getVar CORS_REQUESTS_ALLOWED_DOMAINS "")
	CORS_REQUESTS_ALLOWED_METHODS=$(getVar CORS_REQUESTS_ALLOWED_METHODS "GET,HEAD,POST")
	CORS_REQUESTS_ALLOWED_HEADERS=$(getVar CORS_REQUESTS_ALLOWED_HEADERS "CONTENT-TYPE,X-CSRF-TOKEN")
	CORS_REQUESTS_ALLOW_CREDENTIALS=$(getVar CORS_REQUESTS_ALLOW_CREDENTIALS "true")
	CORS_REQUESTS_EXPOSED_HEADERS=$(getVar CORS_REQUESTS_EXPOSED_HEADERS "")
	CORS_ROOT_CONFIG_IS_ABSTRACT=$(getVar CORS_ROOT_CONFIG_IS_ABSTRACT "false")

	REPOSITORY_SINGLE_TENANT_ADMIN_USERNAME=$(getVar REPOSITORY_SINGLE_TENANT_ADMIN_USERNAME "admin")
	REPOSITORY_SINGLE_TENANT_ADMIN_AUTHORITY_NAME=$(getVar REPOSITORY_SINGLE_TENANT_ADMIN_AUTHORITY_NAME "Administrator")
	REPOSITORY_SINGLE_TENANT_AUTHENTICATED_AUTHORITY_NAME=$(getVar REPOSITORY_SINGLE_TENANT_AUTHENTICATED_AUTHORITY_NAME "Authenticated")
	REPOSITORY_SINGLE_TENANT_ANONYMOUS_AUTHORITY_NAME=$(getVar REPOSITORY_SINGLE_TENANT_ANONYMOUS_AUTHORITY_NAME "Anonymous")

	SECURITY_PROVIDER=$(getVar SECURITY_PROVIDER "jackrabbit")
	SECURITY_ROLE_PROVIDER=$(getVar SECURITY_ROLE_PROVIDER "${SECURITY_PROVIDER:?}")
	SECURITY_REQUEST_PARAMETER_AUTHENTICATION_ENABLED=$(getVar SECURITY_REQUEST_PARAMETER_AUTHENTICATION_ENABLED "false")
	SECURITY_SKIP_USER_VERIFICATION_ON_PRINCIPAL_CREATION=$(getVar SECURITY_SKIP_USER_VERIFICATION_ON_PRINCIPAL_CREATION "true")

	LDAP_CONTEXT_SOURCE_PROVIDER_URL=$(getVar LDAP_CONTEXT_SOURCE_PROVIDER_URL "ldap://localhost:389")
	LDAP_CONTEXT_SOURCE_USER_DN=$(getVar LDAP_CONTEXT_SOURCE_USER_DN "cn=admin,dc=example,dc=localhost")
	LDAP_CONTEXT_SOURCE_PASSWORD=$(getVar LDAP_CONTEXT_SOURCE_PASSWORD "password")
	LDAP_ALL_AUTHORITIES_SEARCH_SEARCH_BASE=$(getVar LDAP_ALL_AUTHORITIES_SEARCH_SEARCH_BASE "ou=groups,dc=example,dc=localhost")
	LDAP_ALL_AUTHORITIES_SEARCH_SEARCH_FILTER=$(getVar LDAP_ALL_AUTHORITIES_SEARCH_SEARCH_FILTER "(objectClass=groupOfUniqueNames)")
	LDAP_ALL_AUTHORITIES_SEARCH_SEARCH_SCOPE=$(getVar LDAP_ALL_AUTHORITIES_SEARCH_SEARCH_SCOPE "2")
	LDAP_ALL_AUTHORITIES_SEARCH_ROLE_ATTRIBUTE=$(getVar LDAP_ALL_AUTHORITIES_SEARCH_ROLE_ATTRIBUTE "cn")
	LDAP_ALL_USERNAMES_SEARCH_SEARCH_BASE=$(getVar LDAP_ALL_USERNAMES_SEARCH_SEARCH_BASE "ou=users,dc=example,dc=localhost")
	LDAP_ALL_USERNAMES_SEARCH_SEARCH_FILTER=$(getVar LDAP_ALL_USERNAMES_SEARCH_SEARCH_FILTER "(objectClass=inetOrgPerson)")
	LDAP_ALL_USERNAMES_SEARCH_SEARCH_SCOPE=$(getVar LDAP_ALL_USERNAMES_SEARCH_SEARCH_SCOPE "2")
	LDAP_ALL_USERNAMES_SEARCH_USERNAME_ATTRIBUTE=$(getVar LDAP_ALL_USERNAMES_SEARCH_USERNAME_ATTRIBUTE "cn")
	LDAP_USER_SEARCH_SEARCH_BASE=$(getVar LDAP_USER_SEARCH_SEARCH_BASE "${LDAP_ALL_USERNAMES_SEARCH_SEARCH_BASE:?}")
	LDAP_USER_SEARCH_SEARCH_FILTER=$(getVar LDAP_USER_SEARCH_SEARCH_FILTER "(cn={0})")
	LDAP_POPULATOR_GROUP_SEARCH_BASE=$(getVar LDAP_POPULATOR_GROUP_SEARCH_BASE "${LDAP_ALL_AUTHORITIES_SEARCH_SEARCH_BASE:?}")
	LDAP_POPULATOR_GROUP_SEARCH_FILTER=$(getVar LDAP_POPULATOR_GROUP_SEARCH_FILTER "(uniqueMember={0})")
	LDAP_POPULATOR_GROUP_ROLE_ATTRIBUTE=$(getVar LDAP_POPULATOR_GROUP_ROLE_ATTRIBUTE "${LDAP_ALL_AUTHORITIES_SEARCH_ROLE_ATTRIBUTE:?}")
	LDAP_POPULATOR_SEARCH_SUBTREE=$(getVar LDAP_POPULATOR_SEARCH_SUBTREE "true")
	LDAP_POPULATOR_ROLE_PREFIX=$(getVar LDAP_POPULATOR_ROLE_PREFIX "")
	LDAP_POPULATOR_CONVERT_TO_UPPER_CASE=$(getVar LDAP_POPULATOR_CONVERT_TO_UPPER_CASE "false")
	LDAP_ADMIN_ROLE=$(getVar LDAP_ADMIN_ROLE "cn=Administrator,${LDAP_ALL_AUTHORITIES_SEARCH_SEARCH_BASE:?}")

	JDBCSEC_DATASOURCE_DRIVER_CLASSNAME=$(getVar JDBCSEC_DATASOURCE_DRIVER_CLASSNAME "org.postgresql.Driver")
	JDBCSEC_DATASOURCE_URL=$(getVar JDBCSEC_DATASOURCE_URL "jdbc:postgresql://localhost:5432/userdb")
	JDBCSEC_DATASOURCE_USER=$(getVar JDBCSEC_DATASOURCE_USER "postgres")
	JDBCSEC_DATASOURCE_PASSWORD=$(getVar JDBCSEC_DATASOURCE_PASSWORD "postgres")
	JDBCSEC_DATASOURCE_POOL_VALIDATION_QUERY=$(getVar JDBCSEC_DATASOURCE_POOL_VALIDATION_QUERY "SELECT 1")
	JDBCSEC_DATASOURCE_POOL_MAX_WAIT=$(getVar JDBCSEC_DATASOURCE_POOL_MAX_WAIT "-1")
	JDBCSEC_DATASOURCE_POOL_MAX_ACTIVE=$(getVar JDBCSEC_DATASOURCE_POOL_MAX_ACTIVE "8")
	JDBCSEC_DATASOURCE_POOL_MAX_IDLE=$(getVar JDBCSEC_DATASOURCE_POOL_MAX_IDLE "4")
	JDBCSEC_DATASOURCE_POOL_MIN_IDLE=$(getVar JDBCSEC_DATASOURCE_POOL_MIN_IDLE "0")
	JDBCSEC_AUTHORITIES_BY_USERNAME_QUERY=$(getVar JDBCSEC_AUTHORITIES_BY_USERNAME_QUERY "SELECT username, authority FROM granted_authorities WHERE username = ? ORDER BY authority")
	JDBCSEC_USERS_BY_USERNAME_QUERY=$(getVar JDBCSEC_USERS_BY_USERNAME_QUERY "SELECT username, password, enabled FROM users WHERE username = ? ORDER BY username")
	JDBCSEC_ALL_AUTHORITIES_QUERY=$(getVar JDBCSEC_ALL_AUTHORITIES_QUERY "SELECT authority FROM authorities ORDER BY authority")
	JDBCSEC_ALL_USERNAMES_QUERY=$(getVar JDBCSEC_ALL_USERNAMES_QUERY "SELECT username FROM users ORDER BY username")
	JDBCSEC_ALL_USERNAMES_IN_ROLE_QUERY=$(getVar JDBCSEC_ALL_USERNAMES_IN_ROLE_QUERY "SELECT username FROM granted_authorities WHERE authority = ? ORDER BY username")
	JDBCSEC_ADMIN_ROLE=$(getVar JDBCSEC_ADMIN_ROLE "Administrator")
	JDBCSEC_PASSWORD_ENCODER_CLASS=$(getVar JDBCSEC_PASSWORD_ENCODER_CLASS "org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder")

	CAS_ENABLED=$(getVar CAS_ENABLED "false")
	CAS_URL=$(getVar CAS_URL "${FQSU_PROTOCOL:?}://${FQSU_DOMAIN:?}:${FQSU_PORT:?}/auth/realms/biserver/protocol/cas")
	CAS_SERVICE_URL=$(getVar CAS_SERVICE_URL "${FQSU_PROTOCOL:?}://${FQSU_DOMAIN:?}:${FQSU_PORT:?}/${WEBAPP_PENTAHO_DIRNAME:?}/j_spring_cas_security_check")
	CAS_FAILURE_URL=$(getVar CAS_FAILURE_URL "${FQSU_PROTOCOL:?}://${FQSU_DOMAIN:?}:${FQSU_PORT:?}/cas-failed.html")
	CAS_TICKETVALIDATOR_URL=$(getVar CAS_TICKETVALIDATOR_URL "${CAS_URL:?}")
	CAS_LOGIN_URL=$(getVar CAS_LOGIN_URL "${CAS_URL:?}/login")
	CAS_LOGOUT_URL=$(getVar CAS_LOGOUT_URL "${CAS_URL:?}/logout?service=$(encodeURI "${FQSU_PROTOCOL:?}://${FQSU_DOMAIN:?}:${FQSU_PORT:?}")")
	CAS_PROVIDER_USERDETAILS=$(getVar CAS_PROVIDER_USERDETAILS "userDetailsService")

	SAML_ENABLED=$(getVar SAML_ENABLED "false")

	MAIL_TRANSPORT_PROTOCOL=$(getVar MAIL_TRANSPORT_PROTOCOL "smtp")
	MAIL_SMTP_HOST=$(getVar MAIL_SMTP_HOST "smtp.example.localhost")
	MAIL_SMTP_PORT=$(getVar MAIL_SMTP_PORT "587")
	MAIL_SMTP_AUTH=$(getVar MAIL_SMTP_AUTH "true")
	MAIL_SMTP_USER=$(getVar MAIL_SMTP_USER "user@example.localhost")
	MAIL_SMTP_PASSWORD=$(getVar MAIL_SMTP_PASSWORD "password")
	MAIL_SMTP_STARTTLS=$(getVar MAIL_SMTP_STARTTLS "true")
	MAIL_SMTP_SSL=$(getVar MAIL_SMTP_SSL "true")
	MAIL_SMTP_QUITWAIT=$(getVar MAIL_SMTP_QUITWAIT "false")
	MAIL_SMTP_FROM_ADDRESS=$(getVar MAIL_SMTP_FROM_ADDRESS "${MAIL_SMTP_USER:?}")
	MAIL_SMTP_FROM_NAME=$(getVar MAIL_SMTP_FROM_NAME "BI Server")
	MAIL_DEBUG=$(getVar MAIL_DEBUG "false")

	STORAGE_TYPE=$(getVar STORAGE_TYPE "local")
	LOAD_SAMPLES=$(getVar LOAD_SAMPLES "true")

	REPOSITORY_CLEANER_SYSTEM_LISTENER_ENABLED=$(getVar REPOSITORY_CLEANER_SYSTEM_LISTENER_ENABLED "true")
	REPOSITORY_CLEANER_SYSTEM_LISTENER_EXECUTE=$(getVar REPOSITORY_CLEANER_SYSTEM_LISTENER_EXECUTE "weekly")

	POSTGRES_HOST=$(getVar POSTGRES_HOST "localhost")
	POSTGRES_PORT=$(getVar POSTGRES_PORT "5432")
	POSTGRES_USER=$(getVar POSTGRES_USER "postgres")
	POSTGRES_PASSWORD=$(getVar POSTGRES_PASSWORD "postgres")
	POSTGRES_DATABASE=$(getVar POSTGRES_DATABASE "postgres")
	POSTGRES_JDBC_URL=$(getVar POSTGRES_JDBC_URL "jdbc:postgresql://${POSTGRES_HOST:?}:${POSTGRES_PORT:?}")
	POSTGRES_JDBC_PROPS=$(getVar POSTGRES_JDBC_PROPS "")
	POSTGRES_JACKRABBIT_USER=$(getVar POSTGRES_JACKRABBIT_USER "jcr_user")
	POSTGRES_JACKRABBIT_PASSWORD=$(getVar POSTGRES_JACKRABBIT_PASSWORD "jcr_password")
	POSTGRES_JACKRABBIT_DATABASE=$(getVar POSTGRES_JACKRABBIT_DATABASE "jackrabbit")
	POSTGRES_JACKRABBIT_JDBC_URL=$(getVar POSTGRES_JACKRABBIT_JDBC_URL "${POSTGRES_JDBC_URL:?}/${POSTGRES_JACKRABBIT_DATABASE:?}?${POSTGRES_JDBC_PROPS?}")
	POSTGRES_HIBERNATE_USER=$(getVar POSTGRES_HIBERNATE_USER "hibuser")
	POSTGRES_HIBERNATE_PASSWORD=$(getVar POSTGRES_HIBERNATE_PASSWORD "hibpassword")
	POSTGRES_HIBERNATE_DATABASE=$(getVar POSTGRES_HIBERNATE_DATABASE "hibernate")
	POSTGRES_HIBERNATE_JDBC_URL=$(getVar POSTGRES_HIBERNATE_JDBC_URL "${POSTGRES_JDBC_URL:?}/${POSTGRES_HIBERNATE_DATABASE:?}?${POSTGRES_JDBC_PROPS?}")
	POSTGRES_QUARTZ_USER=$(getVar POSTGRES_QUARTZ_USER "pentaho_user")
	POSTGRES_QUARTZ_PASSWORD=$(getVar POSTGRES_QUARTZ_PASSWORD "pentaho_password")
	POSTGRES_QUARTZ_DATABASE=$(getVar POSTGRES_QUARTZ_DATABASE "quartz")
	POSTGRES_QUARTZ_JDBC_URL=$(getVar POSTGRES_QUARTZ_JDBC_URL "${POSTGRES_JDBC_URL:?}/${POSTGRES_QUARTZ_DATABASE:?}?${POSTGRES_JDBC_PROPS?}")
	POSTGRES_AUDIT_USER=$(getVar POSTGRES_AUDIT_USER "audit_user")
	POSTGRES_AUDIT_PASSWORD=$(getVar POSTGRES_AUDIT_PASSWORD "audit_password")
	POSTGRES_AUDIT_DATABASE=$(getVar POSTGRES_AUDIT_DATABASE "audit")
	POSTGRES_AUDIT_JDBC_URL=$(getVar POSTGRES_AUDIT_JDBC_URL "${POSTGRES_JDBC_URL:?}/${POSTGRES_AUDIT_DATABASE:?}?${POSTGRES_JDBC_PROPS?}")

	COCKROACH_HOST=$(getVar COCKROACH_HOST "localhost")
	COCKROACH_PORT=$(getVar COCKROACH_PORT "26257")
	COCKROACH_USER=$(getVar COCKROACH_USER "root")
	COCKROACH_PASSWORD=$(getVar COCKROACH_PASSWORD "root")
	COCKROACH_DATABASE=$(getVar COCKROACH_DATABASE "defaultdb")
	COCKROACH_JDBC_URL=$(getVar COCKROACH_JDBC_URL "jdbc:postgresql://${COCKROACH_HOST:?}:${COCKROACH_PORT:?}")
	COCKROACH_JDBC_PROPS=$(getVar COCKROACH_JDBC_PROPS "")
	COCKROACH_JACKRABBIT_USER=$(getVar COCKROACH_JACKRABBIT_USER "jcr_user")
	COCKROACH_JACKRABBIT_PASSWORD=$(getVar COCKROACH_JACKRABBIT_PASSWORD "jcr_password")
	COCKROACH_JACKRABBIT_DATABASE=$(getVar COCKROACH_JACKRABBIT_DATABASE "jackrabbit")
	COCKROACH_JACKRABBIT_JDBC_URL=$(getVar COCKROACH_JACKRABBIT_JDBC_URL "${COCKROACH_JDBC_URL:?}/${COCKROACH_JACKRABBIT_DATABASE:?}?${COCKROACH_JDBC_PROPS?}")
	COCKROACH_HIBERNATE_USER=$(getVar COCKROACH_HIBERNATE_USER "hibuser")
	COCKROACH_HIBERNATE_PASSWORD=$(getVar COCKROACH_HIBERNATE_PASSWORD "hibpassword")
	COCKROACH_HIBERNATE_DATABASE=$(getVar COCKROACH_HIBERNATE_DATABASE "hibernate")
	COCKROACH_HIBERNATE_JDBC_URL=$(getVar COCKROACH_HIBERNATE_JDBC_URL "${COCKROACH_JDBC_URL:?}/${COCKROACH_HIBERNATE_DATABASE:?}?${COCKROACH_JDBC_PROPS?}")
	COCKROACH_QUARTZ_USER=$(getVar COCKROACH_QUARTZ_USER "pentaho_user")
	COCKROACH_QUARTZ_PASSWORD=$(getVar COCKROACH_QUARTZ_PASSWORD "pentaho_password")
	COCKROACH_QUARTZ_DATABASE=$(getVar COCKROACH_QUARTZ_DATABASE "quartz")
	COCKROACH_QUARTZ_JDBC_URL=$(getVar COCKROACH_QUARTZ_JDBC_URL "${COCKROACH_JDBC_URL:?}/${COCKROACH_QUARTZ_DATABASE:?}?${COCKROACH_JDBC_PROPS?}")
	COCKROACH_AUDIT_USER=$(getVar COCKROACH_AUDIT_USER "audit_user")
	COCKROACH_AUDIT_PASSWORD=$(getVar COCKROACH_AUDIT_PASSWORD "audit_password")
	COCKROACH_AUDIT_DATABASE=$(getVar COCKROACH_AUDIT_DATABASE "audit")
	COCKROACH_AUDIT_JDBC_URL=$(getVar COCKROACH_AUDIT_JDBC_URL "${COCKROACH_JDBC_URL:?}/${COCKROACH_AUDIT_DATABASE:?}?${COCKROACH_JDBC_PROPS?}")

	MYSQL_HOST=$(getVar MYSQL_HOST "localhost")
	MYSQL_PORT=$(getVar MYSQL_PORT "3306")
	MYSQL_USER=$(getVar MYSQL_USER "root")
	MYSQL_PASSWORD=$(getVar MYSQL_PASSWORD "root")
	MYSQL_DATABASE=$(getVar MYSQL_DATABASE "mysql")
	MYSQL_JDBC_URL=$(getVar MYSQL_JDBC_URL "jdbc:mysql://${MYSQL_HOST:?}:${MYSQL_PORT:?}")
	MYSQL_JDBC_PROPS=$(getVar MYSQL_JDBC_PROPS "")
	MYSQL_JACKRABBIT_USER=$(getVar MYSQL_JACKRABBIT_USER "jcr_user")
	MYSQL_JACKRABBIT_PASSWORD=$(getVar MYSQL_JACKRABBIT_PASSWORD "jcr_password")
	MYSQL_JACKRABBIT_DATABASE=$(getVar MYSQL_JACKRABBIT_DATABASE "jackrabbit")
	MYSQL_JACKRABBIT_JDBC_URL=$(getVar MYSQL_JACKRABBIT_JDBC_URL "${MYSQL_JDBC_URL:?}/${MYSQL_JACKRABBIT_DATABASE:?}?${MYSQL_JDBC_PROPS?}")
	MYSQL_HIBERNATE_USER=$(getVar MYSQL_HIBERNATE_USER "hibuser")
	MYSQL_HIBERNATE_PASSWORD=$(getVar MYSQL_HIBERNATE_PASSWORD "hibpassword")
	MYSQL_HIBERNATE_DATABASE=$(getVar MYSQL_HIBERNATE_DATABASE "hibernate")
	MYSQL_HIBERNATE_JDBC_URL=$(getVar MYSQL_HIBERNATE_JDBC_URL "${MYSQL_JDBC_URL:?}/${MYSQL_HIBERNATE_DATABASE:?}?${MYSQL_JDBC_PROPS?}")
	MYSQL_QUARTZ_USER=$(getVar MYSQL_QUARTZ_USER "pentaho_user")
	MYSQL_QUARTZ_PASSWORD=$(getVar MYSQL_QUARTZ_PASSWORD "pentaho_password")
	MYSQL_QUARTZ_DATABASE=$(getVar MYSQL_QUARTZ_DATABASE "quartz")
	MYSQL_QUARTZ_JDBC_URL=$(getVar MYSQL_QUARTZ_JDBC_URL "${MYSQL_JDBC_URL:?}/${MYSQL_QUARTZ_DATABASE:?}?${MYSQL_JDBC_PROPS?}")
	MYSQL_AUDIT_USER=$(getVar MYSQL_AUDIT_USER "audit_user")
	MYSQL_AUDIT_PASSWORD=$(getVar MYSQL_AUDIT_PASSWORD "audit_password")
	MYSQL_AUDIT_DATABASE=$(getVar MYSQL_AUDIT_DATABASE "audit")
	MYSQL_AUDIT_JDBC_URL=$(getVar MYSQL_AUDIT_JDBC_URL "${MYSQL_JDBC_URL:?}/${MYSQL_AUDIT_DATABASE:?}?${MYSQL_JDBC_PROPS?}")

	TIDB_HOST=$(getVar TIDB_HOST "localhost")
	TIDB_PORT=$(getVar TIDB_PORT "4000")
	TIDB_USER=$(getVar TIDB_USER "root")
	TIDB_PASSWORD=$(getVar TIDB_PASSWORD "root")
	TIDB_DATABASE=$(getVar TIDB_DATABASE "mysql")
	TIDB_JDBC_URL=$(getVar TIDB_JDBC_URL "jdbc:mysql://${TIDB_HOST:?}:${TIDB_PORT:?}")
	TIDB_JDBC_PROPS=$(getVar TIDB_JDBC_PROPS "")
	TIDB_JACKRABBIT_USER=$(getVar TIDB_JACKRABBIT_USER "jcr_user")
	TIDB_JACKRABBIT_PASSWORD=$(getVar TIDB_JACKRABBIT_PASSWORD "jcr_password")
	TIDB_JACKRABBIT_DATABASE=$(getVar TIDB_JACKRABBIT_DATABASE "jackrabbit")
	TIDB_JACKRABBIT_JDBC_URL=$(getVar TIDB_JACKRABBIT_JDBC_URL "${TIDB_JDBC_URL:?}/${TIDB_JACKRABBIT_DATABASE:?}?${TIDB_JDBC_PROPS?}")
	TIDB_HIBERNATE_USER=$(getVar TIDB_HIBERNATE_USER "hibuser")
	TIDB_HIBERNATE_PASSWORD=$(getVar TIDB_HIBERNATE_PASSWORD "hibpassword")
	TIDB_HIBERNATE_DATABASE=$(getVar TIDB_HIBERNATE_DATABASE "hibernate")
	TIDB_HIBERNATE_JDBC_URL=$(getVar TIDB_HIBERNATE_JDBC_URL "${TIDB_JDBC_URL:?}/${TIDB_HIBERNATE_DATABASE:?}?${TIDB_JDBC_PROPS?}")
	TIDB_QUARTZ_USER=$(getVar TIDB_QUARTZ_USER "pentaho_user")
	TIDB_QUARTZ_PASSWORD=$(getVar TIDB_QUARTZ_PASSWORD "pentaho_password")
	TIDB_QUARTZ_DATABASE=$(getVar TIDB_QUARTZ_DATABASE "quartz")
	TIDB_QUARTZ_JDBC_URL=$(getVar TIDB_QUARTZ_JDBC_URL "${TIDB_JDBC_URL:?}/${TIDB_QUARTZ_DATABASE:?}?${TIDB_JDBC_PROPS?}")
	TIDB_AUDIT_USER=$(getVar TIDB_AUDIT_USER "audit_user")
	TIDB_AUDIT_PASSWORD=$(getVar TIDB_AUDIT_PASSWORD "audit_password")
	TIDB_AUDIT_DATABASE=$(getVar TIDB_AUDIT_DATABASE "audit")
	TIDB_AUDIT_JDBC_URL=$(getVar TIDB_AUDIT_JDBC_URL "${TIDB_JDBC_URL:?}/${TIDB_AUDIT_DATABASE:?}?${TIDB_JDBC_PROPS?}")

	ORACLE_HOST=$(getVar ORACLE_HOST "localhost")
	ORACLE_PORT=$(getVar ORACLE_PORT "1521")
	ORACLE_USER=$(getVar ORACLE_USER "system")
	ORACLE_PASSWORD=$(getVar ORACLE_PASSWORD "system")
	ORACLE_CONNECTION=$(getVar ORACLE_CONNECTION "SID")
	if [ "${ORACLE_CONNECTION:?}" = 'SID' ]; then
		ORACLE_SID=$(getVar ORACLE_SID "XE")
		ORACLE_JDBC_URL=$(getVar ORACLE_JDBC_URL "jdbc:oracle:thin:@${ORACLE_HOST:?}:${ORACLE_PORT:?}:${ORACLE_SID:?}")
	elif [ "${ORACLE_CONNECTION:?}" = 'ServiceName' ]; then
		ORACLE_SERVICE_NAME=$(getVar ORACLE_SERVICE_NAME "XE")
		ORACLE_JDBC_URL=$(getVar ORACLE_JDBC_URL "jdbc:oracle:thin:@//${ORACLE_HOST:?}:${ORACLE_PORT:?}/${ORACLE_SERVICE_NAME:?}")
	fi
	ORACLE_TABLESPACE=$(getVar ORACLE_TABLESPACE "")
	ORACLE_JACKRABBIT_TABLESPACE=$(getVar ORACLE_JACKRABBIT_TABLESPACE "${ORACLE_TABLESPACE:-}")
	ORACLE_JACKRABBIT_USER=$(getVar ORACLE_JACKRABBIT_USER "jcr_user")
	ORACLE_JACKRABBIT_PASSWORD=$(getVar ORACLE_JACKRABBIT_PASSWORD "jcr_password")
	ORACLE_JACKRABBIT_JDBC_URL=$(getVar ORACLE_JACKRABBIT_JDBC_URL "${ORACLE_JDBC_URL:?}")
	ORACLE_HIBERNATE_TABLESPACE=$(getVar ORACLE_HIBERNATE_TABLESPACE "${ORACLE_TABLESPACE:-}")
	ORACLE_HIBERNATE_USER=$(getVar ORACLE_HIBERNATE_USER "hibuser")
	ORACLE_HIBERNATE_PASSWORD=$(getVar ORACLE_HIBERNATE_PASSWORD "hibpassword")
	ORACLE_HIBERNATE_JDBC_URL=$(getVar ORACLE_HIBERNATE_JDBC_URL "${ORACLE_JDBC_URL:?}")
	ORACLE_QUARTZ_TABLESPACE=$(getVar ORACLE_QUARTZ_TABLESPACE "${ORACLE_TABLESPACE:-}")
	ORACLE_QUARTZ_USER=$(getVar ORACLE_QUARTZ_USER "pentaho_user")
	ORACLE_QUARTZ_PASSWORD=$(getVar ORACLE_QUARTZ_PASSWORD "pentaho_password")
	ORACLE_QUARTZ_JDBC_URL=$(getVar ORACLE_QUARTZ_JDBC_URL "${ORACLE_JDBC_URL:?}")
	ORACLE_AUDIT_TABLESPACE=$(getVar ORACLE_AUDIT_TABLESPACE "${ORACLE_TABLESPACE:-}")
	ORACLE_AUDIT_USER=$(getVar ORACLE_AUDIT_USER "audit_user")
	ORACLE_AUDIT_PASSWORD=$(getVar ORACLE_AUDIT_PASSWORD "audit_password")
	ORACLE_AUDIT_JDBC_URL=$(getVar ORACLE_AUDIT_JDBC_URL "${ORACLE_JDBC_URL:?}")

	FILE_UPLOAD_DEFAULTS_MAX_FILE_LIMIT=$(getVar FILE_UPLOAD_DEFAULTS_MAX_FILE_LIMIT "128000000")
	FILE_UPLOAD_DEFAULTS_MAX_FOLDER_LIMIT=$(getVar FILE_UPLOAD_DEFAULTS_MAX_FOLDER_LIMIT "512000000")

	HIDE_USER_HOME_FOLDER_ON_CREATE=$(getVar HIDE_USER_HOME_FOLDER_ON_CREATE "false")
	DEFAULT_FOLDER_WHEN_HOME_FOLDER_IS_HIDDEN=$(getVar DEFAULT_FOLDER_WHEN_HOME_FOLDER_IS_HIDDEN "/public")

	LOG_LEVEL_PENTAHO=$(getVar LOG_LEVEL_PENTAHO "INFO")
	LOG_LEVEL_SECURITY=$(getVar LOG_LEVEL_SECURITY "ERROR")
	LOG_LEVEL_MONDRIAN=$(getVar LOG_LEVEL_MONDRIAN "ERROR")
	LOG_LEVEL_MDXLOG=$(getVar LOG_LEVEL_MDXLOG "DEBUG")
	LOG_LEVEL_SQLLOG=$(getVar LOG_LEVEL_SQLLOG "DEBUG")
	LOG_LEVEL_METADATASQLLOG=$(getVar LOG_LEVEL_METADATASQLLOG "ERROR")
	LOG_LEVEL_ANALYZER=$(getVar LOG_LEVEL_ANALYZER "ERROR")
	LOG_LEVEL_DI=$(getVar LOG_LEVEL_DI "INFO")

	set +a
}

########

# Pre-init.d setup
/usr/share/biserver/bin/setup-pre-initd.sh

# init.d setup
/usr/share/biserver/bin/setup-initd.sh "${BISERVER_PRIV_INITD:?}" "${BISERVER_INITD:?}"

# Post-init.d setup
/usr/share/biserver/bin/setup-post-initd.sh

########

# Clean up temp directory
find "${TMPDIR:-/tmp}" -mindepth 1 -writable -delete 2>/dev/null ||:
