#!/bin/sh

set -eu
export LC_ALL=C

# shellcheck source=./set-utils.sh
. /usr/share/biserver/bin/set-utils.sh

########

# shellcheck disable=SC2034
{
	set -a

	INSTANCE_ID=$(getVar INSTANCE_ID "$(uuidgen | tr -d '-')")

	IS_EXPORTING=$(getVar IS_EXPORTING "false")

	TOMCAT_SHUTDOWN_PORT=$(getVar TOMCAT_SHUTDOWN_PORT "8005")
	TOMCAT_HTTP_PORT=$(getVar TOMCAT_HTTP_PORT "8080")
	TOMCAT_AJP_PORT=$(getVar TOMCAT_AJP_PORT "8009")
	HSQLDB_PORT=$(getVar HSQLDB_PORT "9001")
	KARAF_STARTPORT=$(getVar KARAF_STARTPORT "8801")
	KARAF_ENDPORT=$(getVar KARAF_ENDPORT "8899")
	OSGI_SERVICE_STARTPORT=$(getVar OSGI_SERVICE_STARTPORT "9050")
	OSGI_SERVICE_ENDPORT=$(getVar OSGI_SERVICE_ENDPORT "9149")

	IS_PROXIED=$(getVar IS_PROXIED "false")
	PROXY_SCHEME=$(getVar PROXY_SCHEME "https")
	PROXY_PORT=$(getVar PROXY_PORT "443")

	FQSU_PROTOCOL=$(getVar FQSU_PROTOCOL "http")
	FQSU_DOMAIN=$(getVar FQSU_DOMAIN "localhost")
	FQSU_PORT=$(getVar FQSU_PORT "${TOMCAT_HTTP_PORT:?}")

	DEFAULT_ADMIN_PASSWORD=$(getPasswordVar DEFAULT_ADMIN_PASSWORD "")
	DEFAULT_NON_ADMIN_PASSWORD=$(getPasswordVar DEFAULT_NON_ADMIN_PASSWORD "${DEFAULT_ADMIN_PASSWORD:?}")

	COOKIE_SESSION_TIMEOUT=$(getVar COOKIE_SESSION_TIMEOUT "120")

	SECURITY_PROVIDER=$(getVar SECURITY_PROVIDER "jackrabbit")
	SECURITY_REQUEST_PARAMETER_AUTHENTICATION_ENABLED=$(getVar SECURITY_REQUEST_PARAMETER_AUTHENTICATION_ENABLED "true")
	SECURITY_SKIP_USER_VERIFICATION_ON_PRINCIPAL_CREATION=$(getVar SECURITY_SKIP_USER_VERIFICATION_ON_PRINCIPAL_CREATION "true")

	LDAP_CONTEXT_SOURCE_PROVIDER_URL=$(getVar LDAP_CONTEXT_SOURCE_PROVIDER_URL "ldap://localhost:389")
	LDAP_CONTEXT_SOURCE_USER_DN=$(getVar LDAP_CONTEXT_SOURCE_USER_DN "cn=admin,dc=example,dc=localdomain")
	LDAP_CONTEXT_SOURCE_PASSWORD=$(getVar LDAP_CONTEXT_SOURCE_PASSWORD "password")
	LDAP_USER_SEARCH_SEARCH_BASE=$(getVar LDAP_USER_SEARCH_SEARCH_BASE "ou=users,dc=example,dc=localdomain")
	LDAP_USER_SEARCH_SEARCH_FILTER=$(getVar LDAP_USER_SEARCH_SEARCH_FILTER "(cn={0})")
	LDAP_POPULATOR_CONVERT_TO_UPPER_CASE=$(getVar LDAP_POPULATOR_CONVERT_TO_UPPER_CASE "false")
	LDAP_POPULATOR_GROUP_ROLE_ATTRIBUTE=$(getVar LDAP_POPULATOR_GROUP_ROLE_ATTRIBUTE "cn")
	LDAP_POPULATOR_GROUP_SEARCH_BASE=$(getVar LDAP_POPULATOR_GROUP_SEARCH_BASE "ou=groups,dc=example,dc=localdomain")
	LDAP_POPULATOR_GROUP_SEARCH_FILTER=$(getVar LDAP_POPULATOR_GROUP_SEARCH_FILTER "(uniqueMember={0})")
	LDAP_POPULATOR_ROLE_PREFIX=$(getVar LDAP_POPULATOR_ROLE_PREFIX "")
	LDAP_POPULATOR_SEARCH_SUBTREE=$(getVar LDAP_POPULATOR_SEARCH_SUBTREE "false")
	LDAP_ALL_AUTHORITIES_SEARCH_ROLE_ATTRIBUTE=$(getVar LDAP_ALL_AUTHORITIES_SEARCH_ROLE_ATTRIBUTE "cn")
	LDAP_ALL_AUTHORITIES_SEARCH_SEARCH_BASE=$(getVar LDAP_ALL_AUTHORITIES_SEARCH_SEARCH_BASE "ou=groups,dc=example,dc=localdomain")
	LDAP_ALL_AUTHORITIES_SEARCH_SEARCH_FILTER=$(getVar LDAP_ALL_AUTHORITIES_SEARCH_SEARCH_FILTER "(objectClass=groupOfUniqueNames)")
	LDAP_ALL_USERNAMES_SEARCH_USERNAME_ATTRIBUTE=$(getVar LDAP_ALL_USERNAMES_SEARCH_USERNAME_ATTRIBUTE "cn")
	LDAP_ALL_USERNAMES_SEARCH_SEARCH_BASE=$(getVar LDAP_ALL_USERNAMES_SEARCH_SEARCH_BASE "ou=users,dc=example,dc=localdomain")
	LDAP_ALL_USERNAMES_SEARCH_SEARCH_FILTER=$(getVar LDAP_ALL_USERNAMES_SEARCH_SEARCH_FILTER "(objectClass=inetOrgPerson)")
	LDAP_ADMIN_ROLE=$(getVar LDAP_ADMIN_ROLE "cn=Administrator,ou=groups,dc=example,dc=localdomain")

	JDBCSEC_DATASOURCE_DRIVER_CLASSNAME=$(getVar JDBCSEC_DATASOURCE_DRIVER_CLASSNAME "org.postgresql.Driver")
	JDBCSEC_DATASOURCE_URL=$(getVar JDBCSEC_DATASOURCE_URL "jdbc:postgresql://localhost:5432/userdb")
	JDBCSEC_DATASOURCE_USER=$(getVar JDBCSEC_DATASOURCE_USER "postgres")
	JDBCSEC_DATASOURCE_PASSWORD=$(getVar JDBCSEC_DATASOURCE_PASSWORD "postgres")
	JDBCSEC_DATASOURCE_VALIDATION_QUERY=$(getVar JDBCSEC_DATASOURCE_VALIDATION_QUERY "SELECT 1")
	JDBCSEC_DATASOURCE_POOL_MAX_WAIT=$(getVar JDBCSEC_DATASOURCE_POOL_MAX_WAIT "-1")
	JDBCSEC_DATASOURCE_POOL_MAX_ACTIVE=$(getVar JDBCSEC_DATASOURCE_POOL_MAX_ACTIVE "8")
	JDBCSEC_DATASOURCE_POOL_MAX_IDLE=$(getVar JDBCSEC_DATASOURCE_POOL_MAX_IDLE "4")
	JDBCSEC_DATASOURCE_POOL_MIN_IDLE=$(getVar JDBCSEC_DATASOURCE_POOL_MIN_IDLE "0")
	JDBCSEC_AUTHORITIES_BY_USERNAME_QUERY=$(getVar JDBCSEC_AUTHORITIES_BY_USERNAME_QUERY "SELECT username, authority FROM granted_authorities WHERE username = ? ORDER BY authority")
	JDBCSEC_USERS_BY_USERNAME_QUERY=$(getVar JDBCSEC_USERS_BY_USERNAME_QUERY "SELECT username, password, enabled FROM users WHERE username = ? ORDER BY username")
	JDBCSEC_ALL_AUTHORITIES_QUERY=$(getVar JDBCSEC_ALL_AUTHORITIES_QUERY "SELECT DISTINCT(authority) AS authority FROM authorities ORDER BY authority")
	JDBCSEC_ALL_USERNAMES_IN_ROLE_QUERY=$(getVar JDBCSEC_ALL_USERNAMES_IN_ROLE_QUERY "SELECT DISTINCT(username) AS username FROM granted_authorities WHERE authority = ? ORDER BY username")
	JDBCSEC_ALL_USERNAMES_QUERY=$(getVar JDBCSEC_ALL_USERNAMES_QUERY "SELECT DISTINCT(username) AS username FROM users ORDER BY username")
	JDBCSEC_ADMIN_ROLE=$(getVar JDBCSEC_ADMIN_ROLE "Administrator")

	CAS_ENABLED=$(getVar CAS_ENABLED "false")
	CAS_URL=$(getVar CAS_URL "${FQSU_PROTOCOL:?}://${FQSU_DOMAIN:?}:${FQSU_PORT:?}/auth/realms/biserver/protocol/cas")
	CAS_SERVICE_URL=$(getVar CAS_SERVICE_URL "${FQSU_PROTOCOL:?}://${FQSU_DOMAIN:?}:${FQSU_PORT:?}/${WEBAPP_PENTAHO_DIRNAME:?}/j_spring_cas_security_check")
	CAS_FAILURE_URL=$(getVar CAS_FAILURE_URL "${FQSU_PROTOCOL:?}://${FQSU_DOMAIN:?}:${FQSU_PORT:?}/cas-failed.html")
	CAS_TICKETVALIDATOR_URL=$(getVar CAS_TICKETVALIDATOR_URL "${CAS_URL:?}")
	CAS_LOGIN_URL=$(getVar CAS_LOGIN_URL "${CAS_URL:?}/login")
	CAS_LOGOUT_URL=$(getVar CAS_LOGOUT_URL "${CAS_URL:?}/logout?service=$(encodeURI "${FQSU_PROTOCOL:?}://${FQSU_DOMAIN:?}:${FQSU_PORT:?}")")
	CAS_PROVIDER_USERDETAILS=$(getVar CAS_PROVIDER_USERDETAILS "userDetailsService")

	MAIL_TRANSPORT_PROTOCOL=$(getVar MAIL_TRANSPORT_PROTOCOL "smtp")
	MAIL_SMTP_HOST=$(getVar MAIL_SMTP_HOST "smtp.example.localdomain")
	MAIL_SMTP_PORT=$(getVar MAIL_SMTP_PORT "587")
	MAIL_SMTP_AUTH=$(getVar MAIL_SMTP_AUTH "true")
	MAIL_SMTP_USER=$(getVar MAIL_SMTP_USER "user@example.localdomain")
	MAIL_SMTP_PASSWORD=$(getVar MAIL_SMTP_PASSWORD "password")
	MAIL_SMTP_STARTTLS=$(getVar MAIL_SMTP_STARTTLS "true")
	MAIL_SMTP_SSL=$(getVar MAIL_SMTP_SSL "true")
	MAIL_SMTP_QUITWAIT=$(getVar MAIL_SMTP_QUITWAIT "false")
	MAIL_SMTP_FROM_ADDRESS=$(getVar MAIL_SMTP_FROM_ADDRESS "${MAIL_SMTP_USER:?}")
	MAIL_SMTP_FROM_NAME=$(getVar MAIL_SMTP_FROM_NAME "BI Server")
	MAIL_DEBUG=$(getVar MAIL_DEBUG "false")

	STORAGE_TYPE=$(getVar STORAGE_TYPE "local")
	LOAD_SAMPLES=$(getVar LOAD_SAMPLES "true")

	POSTGRES_HOST=$(getVar POSTGRES_HOST "localhost")
	POSTGRES_PORT=$(getVar POSTGRES_PORT "5432")
	POSTGRES_USER=$(getVar POSTGRES_USER "postgres")
	POSTGRES_PASSWORD=$(getVar POSTGRES_PASSWORD "postgres")
	POSTGRES_DATABASE=$(getVar POSTGRES_DATABASE "postgres")
	POSTGRES_JDBC_URL=$(getVar POSTGRES_JDBC_URL "jdbc:postgresql://${POSTGRES_HOST:?}:${POSTGRES_PORT:?}")
	POSTGRES_JDBC_PROPS=$(getVar POSTGRES_JDBC_PROPS "")
	POSTGRES_JACKRABBIT_USER=$(getVar POSTGRES_JACKRABBIT_USER "jcr_user")
	POSTGRES_JACKRABBIT_PASSWORD=$(getVar POSTGRES_JACKRABBIT_PASSWORD "jcr_password")
	POSTGRES_JACKRABBIT_DATABASE=$(getVar POSTGRES_JACKRABBIT_DATABASE "jackrabbit")
	POSTGRES_JACKRABBIT_JDBC_URL=$(getVar POSTGRES_JACKRABBIT_JDBC_URL "${POSTGRES_JDBC_URL:?}/${POSTGRES_JACKRABBIT_DATABASE:?}?${POSTGRES_JDBC_PROPS?}")
	POSTGRES_HIBERNATE_USER=$(getVar POSTGRES_HIBERNATE_USER "hibuser")
	POSTGRES_HIBERNATE_PASSWORD=$(getVar POSTGRES_HIBERNATE_PASSWORD "hibpassword")
	POSTGRES_HIBERNATE_DATABASE=$(getVar POSTGRES_HIBERNATE_DATABASE "hibernate")
	POSTGRES_HIBERNATE_JDBC_URL=$(getVar POSTGRES_HIBERNATE_JDBC_URL "${POSTGRES_JDBC_URL:?}/${POSTGRES_HIBERNATE_DATABASE:?}?${POSTGRES_JDBC_PROPS?}")
	POSTGRES_QUARTZ_USER=$(getVar POSTGRES_QUARTZ_USER "pentaho_user")
	POSTGRES_QUARTZ_PASSWORD=$(getVar POSTGRES_QUARTZ_PASSWORD "pentaho_password")
	POSTGRES_QUARTZ_DATABASE=$(getVar POSTGRES_QUARTZ_DATABASE "quartz")
	POSTGRES_QUARTZ_JDBC_URL=$(getVar POSTGRES_QUARTZ_JDBC_URL "${POSTGRES_JDBC_URL:?}/${POSTGRES_QUARTZ_DATABASE:?}?${POSTGRES_JDBC_PROPS?}")

	COCKROACH_HOST=$(getVar COCKROACH_HOST "localhost")
	COCKROACH_PORT=$(getVar COCKROACH_PORT "26257")
	COCKROACH_USER=$(getVar COCKROACH_USER "root")
	COCKROACH_PASSWORD=$(getVar COCKROACH_PASSWORD "root")
	COCKROACH_DATABASE=$(getVar COCKROACH_DATABASE "defaultdb")
	COCKROACH_JDBC_URL=$(getVar COCKROACH_JDBC_URL "jdbc:postgresql://${COCKROACH_HOST:?}:${COCKROACH_PORT:?}")
	COCKROACH_JDBC_PROPS=$(getVar COCKROACH_JDBC_PROPS "")
	COCKROACH_JACKRABBIT_USER=$(getVar COCKROACH_JACKRABBIT_USER "jcr_user")
	COCKROACH_JACKRABBIT_PASSWORD=$(getVar COCKROACH_JACKRABBIT_PASSWORD "jcr_password")
	COCKROACH_JACKRABBIT_DATABASE=$(getVar COCKROACH_JACKRABBIT_DATABASE "jackrabbit")
	COCKROACH_JACKRABBIT_JDBC_URL=$(getVar COCKROACH_JACKRABBIT_JDBC_URL "${COCKROACH_JDBC_URL:?}/${COCKROACH_JACKRABBIT_DATABASE:?}?${COCKROACH_JDBC_PROPS?}")
	COCKROACH_HIBERNATE_USER=$(getVar COCKROACH_HIBERNATE_USER "hibuser")
	COCKROACH_HIBERNATE_PASSWORD=$(getVar COCKROACH_HIBERNATE_PASSWORD "hibpassword")
	COCKROACH_HIBERNATE_DATABASE=$(getVar COCKROACH_HIBERNATE_DATABASE "hibernate")
	COCKROACH_HIBERNATE_JDBC_URL=$(getVar COCKROACH_HIBERNATE_JDBC_URL "${COCKROACH_JDBC_URL:?}/${COCKROACH_HIBERNATE_DATABASE:?}?${COCKROACH_JDBC_PROPS?}")
	COCKROACH_QUARTZ_USER=$(getVar COCKROACH_QUARTZ_USER "pentaho_user")
	COCKROACH_QUARTZ_PASSWORD=$(getVar COCKROACH_QUARTZ_PASSWORD "pentaho_password")
	COCKROACH_QUARTZ_DATABASE=$(getVar COCKROACH_QUARTZ_DATABASE "quartz")
	COCKROACH_QUARTZ_JDBC_URL=$(getVar COCKROACH_QUARTZ_JDBC_URL "${COCKROACH_JDBC_URL:?}/${COCKROACH_QUARTZ_DATABASE:?}?${COCKROACH_JDBC_PROPS?}")

	MYSQL_HOST=$(getVar MYSQL_HOST "localhost")
	MYSQL_PORT=$(getVar MYSQL_PORT "3306")
	MYSQL_USER=$(getVar MYSQL_USER "root")
	MYSQL_PASSWORD=$(getVar MYSQL_PASSWORD "root")
	MYSQL_DATABASE=$(getVar MYSQL_DATABASE "mysql")
	MYSQL_JDBC_URL=$(getVar MYSQL_JDBC_URL "jdbc:mysql://${MYSQL_HOST:?}:${MYSQL_PORT:?}")
	MYSQL_JDBC_PROPS=$(getVar MYSQL_JDBC_PROPS "")
	MYSQL_JACKRABBIT_USER=$(getVar MYSQL_JACKRABBIT_USER "jcr_user")
	MYSQL_JACKRABBIT_PASSWORD=$(getVar MYSQL_JACKRABBIT_PASSWORD "jcr_password")
	MYSQL_JACKRABBIT_DATABASE=$(getVar MYSQL_JACKRABBIT_DATABASE "jackrabbit")
	MYSQL_JACKRABBIT_JDBC_URL=$(getVar MYSQL_JACKRABBIT_JDBC_URL "${MYSQL_JDBC_URL:?}/${MYSQL_JACKRABBIT_DATABASE:?}?${MYSQL_JDBC_PROPS?}")
	MYSQL_HIBERNATE_USER=$(getVar MYSQL_HIBERNATE_USER "hibuser")
	MYSQL_HIBERNATE_PASSWORD=$(getVar MYSQL_HIBERNATE_PASSWORD "hibpassword")
	MYSQL_HIBERNATE_DATABASE=$(getVar MYSQL_HIBERNATE_DATABASE "hibernate")
	MYSQL_HIBERNATE_JDBC_URL=$(getVar MYSQL_HIBERNATE_JDBC_URL "${MYSQL_JDBC_URL:?}/${MYSQL_HIBERNATE_DATABASE:?}?${MYSQL_JDBC_PROPS?}")
	MYSQL_QUARTZ_USER=$(getVar MYSQL_QUARTZ_USER "pentaho_user")
	MYSQL_QUARTZ_PASSWORD=$(getVar MYSQL_QUARTZ_PASSWORD "pentaho_password")
	MYSQL_QUARTZ_DATABASE=$(getVar MYSQL_QUARTZ_DATABASE "quartz")
	MYSQL_QUARTZ_JDBC_URL=$(getVar MYSQL_QUARTZ_JDBC_URL "${MYSQL_JDBC_URL:?}/${MYSQL_QUARTZ_DATABASE:?}?${MYSQL_JDBC_PROPS?}")

	TIDB_HOST=$(getVar TIDB_HOST "localhost")
	TIDB_PORT=$(getVar TIDB_PORT "4000")
	TIDB_USER=$(getVar TIDB_USER "root")
	TIDB_PASSWORD=$(getVar TIDB_PASSWORD "root")
	TIDB_DATABASE=$(getVar TIDB_DATABASE "mysql")
	TIDB_JDBC_URL=$(getVar TIDB_JDBC_URL "jdbc:mysql://${TIDB_HOST:?}:${TIDB_PORT:?}")
	TIDB_JDBC_PROPS=$(getVar TIDB_JDBC_PROPS "")
	TIDB_JACKRABBIT_USER=$(getVar TIDB_JACKRABBIT_USER "jcr_user")
	TIDB_JACKRABBIT_PASSWORD=$(getVar TIDB_JACKRABBIT_PASSWORD "jcr_password")
	TIDB_JACKRABBIT_DATABASE=$(getVar TIDB_JACKRABBIT_DATABASE "jackrabbit")
	TIDB_JACKRABBIT_JDBC_URL=$(getVar TIDB_JACKRABBIT_JDBC_URL "${TIDB_JDBC_URL:?}/${TIDB_JACKRABBIT_DATABASE:?}?${TIDB_JDBC_PROPS?}")
	TIDB_HIBERNATE_USER=$(getVar TIDB_HIBERNATE_USER "hibuser")
	TIDB_HIBERNATE_PASSWORD=$(getVar TIDB_HIBERNATE_PASSWORD "hibpassword")
	TIDB_HIBERNATE_DATABASE=$(getVar TIDB_HIBERNATE_DATABASE "hibernate")
	TIDB_HIBERNATE_JDBC_URL=$(getVar TIDB_HIBERNATE_JDBC_URL "${TIDB_JDBC_URL:?}/${TIDB_HIBERNATE_DATABASE:?}?${TIDB_JDBC_PROPS?}")
	TIDB_QUARTZ_USER=$(getVar TIDB_QUARTZ_USER "pentaho_user")
	TIDB_QUARTZ_PASSWORD=$(getVar TIDB_QUARTZ_PASSWORD "pentaho_password")
	TIDB_QUARTZ_DATABASE=$(getVar TIDB_QUARTZ_DATABASE "quartz")
	TIDB_QUARTZ_JDBC_URL=$(getVar TIDB_QUARTZ_JDBC_URL "${TIDB_JDBC_URL:?}/${TIDB_QUARTZ_DATABASE:?}?${TIDB_JDBC_PROPS?}")

	set +a
}

########

# Pre-init.d setup
/usr/share/biserver/bin/setup-pre-initd.sh

# Private init.d setup
/usr/share/biserver/bin/setup-initd.sh "${BISERVER_PRIV_INITD:?}"

# Public init.d setup
/usr/share/biserver/bin/setup-initd.sh "${BISERVER_INITD:?}"

# Post-init.d setup
/usr/share/biserver/bin/setup-post-initd.sh
