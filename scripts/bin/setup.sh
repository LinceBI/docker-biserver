#!/bin/sh

set -eu
export LC_ALL=C

# shellcheck source=./set-utils.sh
. /usr/share/biserver/bin/set-utils.sh

########

# shellcheck disable=SC2034
{
	set -a

	INSTANCE_ID=$(getVar INSTANCE_ID "$(uuidgen | tr -d '-')")

	IS_EXPORTING=$(getVar IS_EXPORTING "false")
	LOAD_SAMPLES=$(getVar LOAD_SAMPLES "true")

	IS_PROXIED=$(getVar IS_PROXIED "false")
	PROXY_SCHEME=$(getVar PROXY_SCHEME "https")
	PROXY_PORT=$(getVar PROXY_PORT "443")

	TOMCAT_SHUTDOWN_PORT=$(getVar TOMCAT_SHUTDOWN_PORT "8005")
	TOMCAT_HTTP_PORT=$(getVar TOMCAT_HTTP_PORT "8080")
	TOMCAT_AJP_PORT=$(getVar TOMCAT_AJP_PORT "8009")
	HSQLDB_PORT=$(getVar HSQLDB_PORT "9001")
	KARAF_STARTPORT=$(getVar KARAF_STARTPORT "8801")
	KARAF_ENDPORT=$(getVar KARAF_ENDPORT "8899")
	OSGI_SERVICE_STARTPORT=$(getVar OSGI_SERVICE_STARTPORT "9050")
	OSGI_SERVICE_ENDPORT=$(getVar OSGI_SERVICE_ENDPORT "9149")
	RMI_SERVER_STARTPORT=$(getVar RMI_SERVER_STARTPORT "44444")
	RMI_SERVER_ENDPORT=$(getVar RMI_SERVER_ENDPORT "44499")
	RMI_REGISTRY_STARTPORT=$(getVar RMI_REGISTRY_STARTPORT "11098")
	RMI_REGISTRY_ENDPORT=$(getVar RMI_REGISTRY_ENDPORT "11190")

	FQSU_PROTOCOL=$(getVar FQSU_PROTOCOL "http")
	FQSU_DOMAIN=$(getVar FQSU_DOMAIN "localhost")
	FQSU_PORT=$(getVar FQSU_PORT "${TOMCAT_HTTP_PORT:?}")

	DEFAULT_ADMIN_PASSWORD=$(getPasswordVar DEFAULT_ADMIN_PASSWORD "")
	DEFAULT_NON_ADMIN_PASSWORD=$(getPasswordVar DEFAULT_NON_ADMIN_PASSWORD "${DEFAULT_ADMIN_PASSWORD:?}")

	MAIL_TRANSPORT_PROTOCOL=$(getVar MAIL_TRANSPORT_PROTOCOL "smtp")
	MAIL_SMTP_HOST=$(getVar MAIL_SMTP_HOST "smtp.example.localdomain")
	MAIL_SMTP_PORT=$(getVar MAIL_SMTP_PORT "587")
	MAIL_SMTP_AUTH=$(getVar MAIL_SMTP_AUTH "true")
	MAIL_SMTP_USER=$(getVar MAIL_SMTP_USER "user@example.localdomain")
	MAIL_SMTP_PASSWORD=$(getVar MAIL_SMTP_PASSWORD "password")
	MAIL_SMTP_STARTTLS=$(getVar MAIL_SMTP_STARTTLS "true")
	MAIL_SMTP_SSL=$(getVar MAIL_SMTP_SSL "true")
	MAIL_SMTP_QUITWAIT=$(getVar MAIL_SMTP_QUITWAIT "false")
	MAIL_SMTP_FROM_ADDRESS=$(getVar MAIL_SMTP_FROM_ADDRESS "${MAIL_SMTP_USER:?}")
	MAIL_SMTP_FROM_NAME=$(getVar MAIL_SMTP_FROM_NAME "BI Server")
	MAIL_DEBUG=$(getVar MAIL_DEBUG "false")

	SECURITY_REQUEST_PARAMETER_AUTHENTICATION_ENABLED=$(getVar SECURITY_REQUEST_PARAMETER_AUTHENTICATION_ENABLED "true")

	STORAGE_TYPE=$(getVar STORAGE_TYPE "local")

	POSTGRES_HOST=$(getVar POSTGRES_HOST "localhost")
	POSTGRES_PORT=$(getVar POSTGRES_PORT "5432")
	POSTGRES_USER=$(getVar POSTGRES_USER "postgres")
	POSTGRES_PASSWORD=$(getVar POSTGRES_PASSWORD "postgres")
	POSTGRES_DATABASE=$(getVar POSTGRES_DATABASE "postgres")
	POSTGRES_JDBC_URL=$(getVar POSTGRES_JDBC_URL "jdbc:postgresql://${POSTGRES_HOST:?}:${POSTGRES_PORT:?}")
	POSTGRES_JDBC_PROPS=$(getVar POSTGRES_JDBC_PROPS "")
	POSTGRES_JACKRABBIT_USER=$(getVar POSTGRES_JACKRABBIT_USER "jcr_user")
	POSTGRES_JACKRABBIT_PASSWORD=$(getVar POSTGRES_JACKRABBIT_PASSWORD "jcr_password")
	POSTGRES_JACKRABBIT_DATABASE=$(getVar POSTGRES_JACKRABBIT_DATABASE "jackrabbit")
	POSTGRES_JACKRABBIT_JDBC_URL=$(getVar POSTGRES_JACKRABBIT_JDBC_URL "${POSTGRES_JDBC_URL:?}/${POSTGRES_JACKRABBIT_DATABASE:?}?${POSTGRES_JDBC_PROPS?}")
	POSTGRES_HIBERNATE_USER=$(getVar POSTGRES_HIBERNATE_USER "hibuser")
	POSTGRES_HIBERNATE_PASSWORD=$(getVar POSTGRES_HIBERNATE_PASSWORD "hibpassword")
	POSTGRES_HIBERNATE_DATABASE=$(getVar POSTGRES_HIBERNATE_DATABASE "hibernate")
	POSTGRES_HIBERNATE_JDBC_URL=$(getVar POSTGRES_HIBERNATE_JDBC_URL "${POSTGRES_JDBC_URL:?}/${POSTGRES_HIBERNATE_DATABASE:?}?${POSTGRES_JDBC_PROPS?}")
	POSTGRES_QUARTZ_USER=$(getVar POSTGRES_QUARTZ_USER "pentaho_user")
	POSTGRES_QUARTZ_PASSWORD=$(getVar POSTGRES_QUARTZ_PASSWORD "pentaho_password")
	POSTGRES_QUARTZ_DATABASE=$(getVar POSTGRES_QUARTZ_DATABASE "quartz")
	POSTGRES_QUARTZ_JDBC_URL=$(getVar POSTGRES_QUARTZ_JDBC_URL "${POSTGRES_JDBC_URL:?}/${POSTGRES_QUARTZ_DATABASE:?}?${POSTGRES_JDBC_PROPS?}")

	COCKROACH_HOST=$(getVar COCKROACH_HOST "localhost")
	COCKROACH_PORT=$(getVar COCKROACH_PORT "26257")
	COCKROACH_USER=$(getVar COCKROACH_USER "root")
	COCKROACH_PASSWORD=$(getVar COCKROACH_PASSWORD "root")
	COCKROACH_DATABASE=$(getVar COCKROACH_DATABASE "defaultdb")
	COCKROACH_JDBC_URL=$(getVar COCKROACH_JDBC_URL "jdbc:postgresql://${COCKROACH_HOST:?}:${COCKROACH_PORT:?}")
	COCKROACH_JDBC_PROPS=$(getVar COCKROACH_JDBC_PROPS "")
	COCKROACH_JACKRABBIT_USER=$(getVar COCKROACH_JACKRABBIT_USER "jcr_user")
	COCKROACH_JACKRABBIT_PASSWORD=$(getVar COCKROACH_JACKRABBIT_PASSWORD "jcr_password")
	COCKROACH_JACKRABBIT_DATABASE=$(getVar COCKROACH_JACKRABBIT_DATABASE "jackrabbit")
	COCKROACH_JACKRABBIT_JDBC_URL=$(getVar COCKROACH_JACKRABBIT_JDBC_URL "${COCKROACH_JDBC_URL:?}/${COCKROACH_JACKRABBIT_DATABASE:?}?${COCKROACH_JDBC_PROPS?}")
	COCKROACH_HIBERNATE_USER=$(getVar COCKROACH_HIBERNATE_USER "hibuser")
	COCKROACH_HIBERNATE_PASSWORD=$(getVar COCKROACH_HIBERNATE_PASSWORD "hibpassword")
	COCKROACH_HIBERNATE_DATABASE=$(getVar COCKROACH_HIBERNATE_DATABASE "hibernate")
	COCKROACH_HIBERNATE_JDBC_URL=$(getVar COCKROACH_HIBERNATE_JDBC_URL "${COCKROACH_JDBC_URL:?}/${COCKROACH_HIBERNATE_DATABASE:?}?${COCKROACH_JDBC_PROPS?}")
	COCKROACH_QUARTZ_USER=$(getVar COCKROACH_QUARTZ_USER "pentaho_user")
	COCKROACH_QUARTZ_PASSWORD=$(getVar COCKROACH_QUARTZ_PASSWORD "pentaho_password")
	COCKROACH_QUARTZ_DATABASE=$(getVar COCKROACH_QUARTZ_DATABASE "quartz")
	COCKROACH_QUARTZ_JDBC_URL=$(getVar COCKROACH_QUARTZ_JDBC_URL "${COCKROACH_JDBC_URL:?}/${COCKROACH_QUARTZ_DATABASE:?}?${COCKROACH_JDBC_PROPS?}")

	MYSQL_HOST=$(getVar MYSQL_HOST "localhost")
	MYSQL_PORT=$(getVar MYSQL_PORT "3306")
	MYSQL_USER=$(getVar MYSQL_USER "root")
	MYSQL_PASSWORD=$(getVar MYSQL_PASSWORD "root")
	MYSQL_DATABASE=$(getVar MYSQL_DATABASE "mysql")
	MYSQL_JDBC_URL=$(getVar MYSQL_JDBC_URL "jdbc:mysql://${MYSQL_HOST:?}:${MYSQL_PORT:?}")
	MYSQL_JDBC_PROPS=$(getVar MYSQL_JDBC_PROPS "")
	MYSQL_JACKRABBIT_USER=$(getVar MYSQL_JACKRABBIT_USER "jcr_user")
	MYSQL_JACKRABBIT_PASSWORD=$(getVar MYSQL_JACKRABBIT_PASSWORD "jcr_password")
	MYSQL_JACKRABBIT_DATABASE=$(getVar MYSQL_JACKRABBIT_DATABASE "jackrabbit")
	MYSQL_JACKRABBIT_JDBC_URL=$(getVar MYSQL_JACKRABBIT_JDBC_URL "${MYSQL_JDBC_URL:?}/${MYSQL_JACKRABBIT_DATABASE:?}?${MYSQL_JDBC_PROPS?}")
	MYSQL_HIBERNATE_USER=$(getVar MYSQL_HIBERNATE_USER "hibuser")
	MYSQL_HIBERNATE_PASSWORD=$(getVar MYSQL_HIBERNATE_PASSWORD "hibpassword")
	MYSQL_HIBERNATE_DATABASE=$(getVar MYSQL_HIBERNATE_DATABASE "hibernate")
	MYSQL_HIBERNATE_JDBC_URL=$(getVar MYSQL_HIBERNATE_JDBC_URL "${MYSQL_JDBC_URL:?}/${MYSQL_HIBERNATE_DATABASE:?}?${MYSQL_JDBC_PROPS?}")
	MYSQL_QUARTZ_USER=$(getVar MYSQL_QUARTZ_USER "pentaho_user")
	MYSQL_QUARTZ_PASSWORD=$(getVar MYSQL_QUARTZ_PASSWORD "pentaho_password")
	MYSQL_QUARTZ_DATABASE=$(getVar MYSQL_QUARTZ_DATABASE "quartz")
	MYSQL_QUARTZ_JDBC_URL=$(getVar MYSQL_QUARTZ_JDBC_URL "${MYSQL_JDBC_URL:?}/${MYSQL_QUARTZ_DATABASE:?}?${MYSQL_JDBC_PROPS?}")

	TIDB_HOST=$(getVar TIDB_HOST "localhost")
	TIDB_PORT=$(getVar TIDB_PORT "4000")
	TIDB_USER=$(getVar TIDB_USER "root")
	TIDB_PASSWORD=$(getVar TIDB_PASSWORD "root")
	TIDB_DATABASE=$(getVar TIDB_DATABASE "mysql")
	TIDB_JDBC_URL=$(getVar TIDB_JDBC_URL "jdbc:mysql://${TIDB_HOST:?}:${TIDB_PORT:?}")
	TIDB_JDBC_PROPS=$(getVar TIDB_JDBC_PROPS "")
	TIDB_JACKRABBIT_USER=$(getVar TIDB_JACKRABBIT_USER "jcr_user")
	TIDB_JACKRABBIT_PASSWORD=$(getVar TIDB_JACKRABBIT_PASSWORD "jcr_password")
	TIDB_JACKRABBIT_DATABASE=$(getVar TIDB_JACKRABBIT_DATABASE "jackrabbit")
	TIDB_JACKRABBIT_JDBC_URL=$(getVar TIDB_JACKRABBIT_JDBC_URL "${TIDB_JDBC_URL:?}/${TIDB_JACKRABBIT_DATABASE:?}?${TIDB_JDBC_PROPS?}")
	TIDB_HIBERNATE_USER=$(getVar TIDB_HIBERNATE_USER "hibuser")
	TIDB_HIBERNATE_PASSWORD=$(getVar TIDB_HIBERNATE_PASSWORD "hibpassword")
	TIDB_HIBERNATE_DATABASE=$(getVar TIDB_HIBERNATE_DATABASE "hibernate")
	TIDB_HIBERNATE_JDBC_URL=$(getVar TIDB_HIBERNATE_JDBC_URL "${TIDB_JDBC_URL:?}/${TIDB_HIBERNATE_DATABASE:?}?${TIDB_JDBC_PROPS?}")
	TIDB_QUARTZ_USER=$(getVar TIDB_QUARTZ_USER "pentaho_user")
	TIDB_QUARTZ_PASSWORD=$(getVar TIDB_QUARTZ_PASSWORD "pentaho_password")
	TIDB_QUARTZ_DATABASE=$(getVar TIDB_QUARTZ_DATABASE "quartz")
	TIDB_QUARTZ_JDBC_URL=$(getVar TIDB_QUARTZ_JDBC_URL "${TIDB_JDBC_URL:?}/${TIDB_QUARTZ_DATABASE:?}?${TIDB_JDBC_PROPS?}")

	set +a
}

########

# Pre-init.d setup
/usr/share/biserver/bin/setup-pre-initd.sh

# Private init.d setup
/usr/share/biserver/bin/setup-initd.sh "${BISERVER_PRIV_INITD:?}"

# Public init.d setup
/usr/share/biserver/bin/setup-initd.sh "${BISERVER_INITD:?}"

# Post-init.d setup
/usr/share/biserver/bin/setup-post-initd.sh
