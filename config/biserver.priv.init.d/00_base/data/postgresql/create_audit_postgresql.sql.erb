-- DROP DATABASE IF EXISTS "<%= ENV['POSTGRES_AUDIT_DATABASE'] %>";
-- DROP USER IF EXISTS "<%= ENV['POSTGRES_AUDIT_USER'] %>";

DO $$
BEGIN
	CREATE USER "<%= ENV['POSTGRES_AUDIT_USER'] %>" PASSWORD '<%= ENV['POSTGRES_AUDIT_PASSWORD'] %>';
	EXCEPTION WHEN DUPLICATE_OBJECT THEN RAISE NOTICE 'User "<%= ENV['POSTGRES_AUDIT_USER'] %>" already exists';
END
$$;
CREATE DATABASE "<%= ENV['POSTGRES_AUDIT_DATABASE'] %>" WITH OWNER = "<%= ENV['POSTGRES_AUDIT_USER'] %>" ENCODING = 'UTF8' TABLESPACE = pg_default;
GRANT ALL PRIVILEGES ON DATABASE "<%= ENV['POSTGRES_AUDIT_DATABASE'] %>" TO "<%= ENV['POSTGRES_AUDIT_USER'] %>";

\connect "<%= ENV['POSTGRES_AUDIT_DATABASE'] %>"

BEGIN;

CREATE TABLE AUDIT (
	JOB_ID VARCHAR(200) NULL,
	INST_ID VARCHAR(200) NULL,
	OBJ_ID VARCHAR(200) NULL,
	OBJ_TYPE VARCHAR(200) NULL,
	ACTOR VARCHAR(200) NULL,
	MESSAGE_TYPE VARCHAR(200) NULL,
	MESSAGE_NAME VARCHAR(200) NULL,
	MESSAGE_TEXT_VALUE VARCHAR(1024) NULL,
	MESSAGE_NUM_VALUE NUMERIC(19,2) NULL,
	DURATION NUMERIC(19,2) NULL,
	AUDIT_TIME TIMESTAMP NULL
) WITH (
	OIDS=FALSE
);

ALTER TABLE AUDIT OWNER TO "<%= ENV['POSTGRES_AUDIT_USER'] %>";

COMMIT;
