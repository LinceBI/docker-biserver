CREATE USER "<%= ENV['PENTAHO_AUDIT_DATABASE_USER'] %>" PASSWORD '<%= ENV['PENTAHO_AUDIT_DATABASE_PASSWORD'] %>';
CREATE DATABASE "<%= ENV['PENTAHO_AUDIT_DATABASE_NAME'] %>" WITH OWNER = "<%= ENV['PENTAHO_AUDIT_DATABASE_USER'] %>" ENCODING = 'UTF8' TABLESPACE = pg_default;

ALTER ROLE "<%= ENV['PENTAHO_AUDIT_DATABASE_USER'] %>" SET "search_path" = "<%= ENV['PENTAHO_AUDIT_DATABASE_NAME'] %>";
GRANT ALL PRIVILEGES ON DATABASE "<%= ENV['PENTAHO_AUDIT_DATABASE_NAME'] %>" TO "<%= ENV['PENTAHO_AUDIT_DATABASE_USER'] %>";

\connect "<%= ENV['PENTAHO_AUDIT_DATABASE_NAME'] %>"

BEGIN;

-- Create schema if needed
CREATE SCHEMA "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>";
-- Grant privileges to new schema (Only when Hibernate connection is not used)
-- GRANT ALL PRIVILEGES ON SCHEMA stmonitoring to stmonituser;

-- Variable table definitions
CREATE TABLE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".var (
  var_id varchar(50)
, var_value varchar(300) NULL
, CONSTRAINT pkey_var PRIMARY KEY (var_id)
) WITH (
  OIDS=FALSE
);

-- Transactional tables definitions
-- Create pentaho audit table
CREATE TABLE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".audit (
  datetime_create TIMESTAMP NULL
, job_id varchar(200) NULL
, inst_id varchar(200) NULL
, obj_id varchar(200) NULL
, obj_type varchar(200) NULL
, actor varchar(200) NULL
, message_type varchar(200) NULL
, message_name varchar(200) NULL
, message_text_value varchar(1024) NULL
, message_num_value numeric(19,2) NULL
, duration numeric(19,2) NULL
) WITH (
  OIDS=FALSE
);

CREATE INDEX idx_audit_dtCreate ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".audit (datetime_create);


-- Analitycal tables definitions
-- Dimensions
-- Time dimension
-- @todo: insertar registro por defecto para las horas desconocidas
CREATE TABLE  "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_time (
   d_time_sk int
,  d_time_hour_12 varchar(2) NULL
,  d_time_hour_12_desc varchar(5) NULL
,  d_time_hour_24 varchar(2) NULL
,  d_time_hour_24_desc varchar(5) NULL
,  d_time_minute varchar(2) NULL
,  d_time_meridiem varchar(2) NULL
,  CONSTRAINT pkey_dtime PRIMARY KEY (d_time_sk)
);

-- !! Index may not be create for increase performance
CREATE INDEX idx_dtime_hour12 ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_time(d_time_hour_12);
CREATE INDEX idx_dtime_hour12Desc ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_time(d_time_hour_12_desc);
CREATE INDEX idx_dtime_hour24 ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_time(d_time_hour_24);
CREATE INDEX idx_dtime_hour24Desc ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_time(d_time_hour_24_desc);
CREATE INDEX idx_dtime_minute ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_time(d_time_minute);
CREATE INDEX idx_dtime_meridiem ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_time(d_time_meridiem);

-- Time dimension
-- @todo: insertar registro por defecto para los días desconocidos
CREATE TABLE  "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date (
  d_date_sk int
, d_date_full date NULL
, d_date_full_desc varchar(50) NULL-- Posible conflicto con internacionalización
, d_date_year varchar(4) NULL
, d_date_quarter varchar(2) NULL
, d_date_month varchar(2) NULL
, d_date_month_desc varchar(12) NULL
, d_date_month_short varchar(4) NULL
, d_date_weekOfMonth varchar(2) NULL
, d_date_weekOfYear varchar(2) NULL
, d_date_weekOfYear_ISO varchar(2) NULL
, d_date_dayOfMonth varchar(2) NULL
, d_date_dayOfWeek varchar(2) NULL
, d_date_dayOfWeek_ISO varchar(2) NULL
, d_date_dayOfWeek_desc varchar(12) NULL
, d_date_dayOfWeek_short varchar(4) NULL
, d_date_dayOfYear varchar(3) NULL
, d_date_dayOfYear_ISO varchar(3) NULL
,  CONSTRAINT pkey_ddate PRIMARY KEY (d_date_sk)
) WITH (
  OIDS=FALSE
);

CREATE INDEX idx_ddate_full ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date(d_date_full);
CREATE INDEX idx_ddate_full_desc ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date(d_date_full_desc);
CREATE INDEX idx_ddate_year ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date(d_date_year);
CREATE INDEX idx_ddate_quarter ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date(d_date_quarter);
CREATE INDEX idx_ddate_month ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date(d_date_month);
CREATE INDEX idx_ddate_month_desc ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date(d_date_month_desc);
CREATE INDEX idx_ddate_month_short ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date(d_date_month_short);
CREATE INDEX idx_ddate_weekOfMonth ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date(d_date_weekOfMonth);
CREATE INDEX idx_ddate_weekOfYear ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date(d_date_weekOfYear);
CREATE INDEX idx_ddate_weekOfYear_ISO ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date(d_date_weekOfYear_ISO);
CREATE INDEX idx_ddate_dayOfMonth ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date(d_date_dayOfMonth);
CREATE INDEX idx_ddate_dayOfWeek ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date(d_date_dayOfWeek);
CREATE INDEX idx_ddate_dayOfWeek_ISO ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date(d_date_dayOfWeek_ISO);
CREATE INDEX idx_ddate_dayOfWeek_desc ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date(d_date_dayOfWeek_desc);
CREATE INDEX idx_ddate_dayOfWeek_short ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date(d_date_dayOfWeek_short);
CREATE INDEX idx_ddate_dayOfYear ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date(d_date_dayOfYear);
CREATE INDEX idx_ddate_dayOfYear_ISO ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date(d_date_dayOfYear_ISO);

-- Session Dimension
CREATE TABLE  "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_session (
  d_session_id varchar(200)
, d_session_type varchar(200)
, d_session_username varchar(200)
, d_session_active boolean
,  CONSTRAINT pkey_dsession PRIMARY KEY (d_session_id)
) WITH (
  OIDS=FALSE
);

CREATE INDEX idx_dsession_type ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_session(d_session_type);
CREATE INDEX idx_dsession_username ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_session(d_session_username);
CREATE INDEX idx_dsession_usernameVersion ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_session(d_session_username,d_session_active);

-- Instance Dimension
CREATE TABLE  "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_instance (
  d_instance_id varchar(200)
, d_instance_engine varchar(200)
, d_instance_service varchar(200)
, d_instance_content varchar(200)
, d_instance_content_type varchar(200)
, d_instance_content_message varchar(1024)
,  CONSTRAINT pkey_dinstance PRIMARY KEY (d_instance_id)
) WITH (
  OIDS=FALSE
);

CREATE INDEX idx_dinstance_eng ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_instance(d_instance_engine);
CREATE INDEX idx_dinstance_serv ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_instance(d_instance_service);
CREATE INDEX idx_dinstance_cont ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_instance(d_instance_content);
CREATE INDEX idx_dinstance_contType ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_instance(d_instance_content_type);

-- Fact tables
-- create session fact table
CREATE TABLE  "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_session (
  date_start_sk int
, date_end_sk int
, time_start_sk int
, time_end_sk int
, session_id varchar(200)
, state varchar(100)
, duration numeric(19,2)
) WITH (
  OIDS=FALSE
);


CREATE INDEX idx_fsession_dstart ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_session(date_start_sk);
CREATE INDEX idx_fsession_dend ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_session(date_end_sk);
CREATE INDEX idx_fsession_tstart ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_session(time_start_sk);
CREATE INDEX idx_fsession_tend ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_session(time_end_sk);
CREATE INDEX idx_fsession_sessId ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_session(session_id);
CREATE INDEX idx_fsession_state ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_session(state);

-- create instance fact table
CREATE TABLE  "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_instance (
  date_start_sk int
, date_end_sk int
, time_start_sk int
, time_end_sk int
, session_id varchar(200)
, instance_id varchar(200)
, state varchar(100)
, duration numeric(19,2)
) WITH (
  OIDS=FALSE
);

CREATE INDEX idx_finstance_dstart ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_instance(date_start_sk);
CREATE INDEX idx_finstance_dend ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_instance(date_end_sk);
CREATE INDEX idx_finstance_tstart ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_instance(time_start_sk);
CREATE INDEX idx_finstance_tend ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_instance(time_end_sk);
CREATE INDEX idx_finstance_sessId ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_instance(session_id);
CREATE INDEX idx_finstance_instId ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_instance(instance_id);
CREATE INDEX idx_finstance_state ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_instance(state);

-- create instance fact table
CREATE TABLE  "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_elements (
  date_start_sk int
, date_end_sk int
, time_start_sk int
, time_end_sk int
, session_id varchar(200)
, instance_id varchar(200)
, state varchar(100)
) WITH (
  OIDS=FALSE
);

CREATE INDEX idx_f_elements_dstart ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_elements(date_start_sk);
CREATE INDEX idx_f_elements_dend ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_elements(date_end_sk);
CREATE INDEX idx_f_elements_tstart ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_elements(time_start_sk);
CREATE INDEX idx_f_elements_tend ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_elements(time_end_sk);
CREATE INDEX idx_f_elements_sessId ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_elements(session_id);
CREATE INDEX idx_f_elements_instId ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_elements(instance_id);
CREATE INDEX idx_f_elements_state ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_elements(state);

-- create session fact table
CREATE TABLE  "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_component (
  date_start_sk int
, date_end_sk int
, time_start_sk int
, time_end_sk int
, session_id varchar(250)
, session_type varchar(250)
, session_username varchar(250)
, instance_id varchar(200)
, instance_engine_id varchar(200)
, instance_service_id varchar(200)
, instance_content_id varchar(100)
, instance_content_detail varchar(1024)
, component_id varchar(200)
, state varchar(100)
, duration numeric(19,2)
) WITH (
  OIDS=FALSE
);

CREATE INDEX idx_fcomponent_dstart ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_component(date_start_sk);
CREATE INDEX idx_fcomponent_dend ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_component(date_end_sk);
CREATE INDEX idx_fcomponent_tstart ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_component(time_start_sk);
CREATE INDEX idx_fcomponent_tend ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_component(time_end_sk);
CREATE INDEX idx_fcomponent_sessId ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_component(session_id);
CREATE INDEX idx_fcomponent_sessType ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_component(session_type);
CREATE INDEX idx_fcomponent_sessUsername ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_component(session_username);
CREATE INDEX idx_fcomponent_instId ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_component(instance_id);
CREATE INDEX idx_fcomponent_instEngId ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_component(instance_engine_id);
CREATE INDEX idx_fcomponent_instServId ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_component(instance_service_id);
CREATE INDEX idx_fcomponent_instContId ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_component(instance_content_id);
CREATE INDEX idx_fcomponent_instContDetail ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_component(instance_content_detail);
CREATE INDEX idx_fcomponent_compId ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_component(component_id);
CREATE INDEX idx_fcomponent_state ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_component(state);

-- create triggers and fuctions
-- d_time update function
CREATE OR REPLACE FUNCTION "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_time_update() RETURNS BOOLEAN AS $$
  DECLARE
    date_base timestamp := timestamp '2000-01-01 00:00:00';
    date_target timestamp := timestamp '2000-01-02 00:00:00';
  BEGIN
    TRUNCATE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_time;  -- Parche mientras se decide el flujo general del proceso
    WHILE date_base <> date_target LOOP
      INSERT INTO "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_time VALUES (
          to_number(to_char(date_base,'HH24MI'),'9999')
        , to_char(date_base,'HH12')
        , to_char(date_base,'HH12:MI')
        , to_char(date_base,'HH24')
        , to_char(date_base,'HH24:MI')
        , to_char(date_base,'MI')
        , to_char(date_base,'AM')
      );
      date_base := date_base + INTERVAL '1 MINUTE';
    END LOOP;
    RETURN TRUE;
  END;
$$ LANGUAGE plpgsql;

-- d_date update function
CREATE OR REPLACE FUNCTION "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date_update(timestamp) RETURNS BOOLEAN AS $$
  DECLARE
    date_base date;
    date_target date := cast ( $1 as date);
  BEGIN
    -- Verify last generate date into d_date
    SELECT CAST (var_value AS date) INTO date_base FROM "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".var WHERE var_id = 'Dim Date. Next Date';
    IF NOT FOUND THEN
      date_base := date_trunc('YEAR',date_target);
      INSERT INTO "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".var VALUES (
          'Dim Date. Next Date'
        , date_base
      );
    END IF;
    -- Verify if actual date is newer than dates in d_date
    IF date_base > date_target THEN
      -- Return true if there is nothing else to do
      RETURN TRUE;
    END IF;
    -- 
    date_target := date_trunc('MONTH',date_target + INTERVAL '1 MONTH');
    WHILE date_base <> date_target LOOP
      INSERT INTO "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date VALUES (
          to_number(to_char(date_base,'FMYYYYMMDD'),'99999999')
        , date_base
        , to_char(date_base,'FMDay, FMDD FMMonth FMYYYY')
        , to_char(date_base,'FMYYYY')
        , to_char(date_base,'FMQ')
        , to_char(date_base,'FMMM')
        , to_char(date_base,'FMMonth')
        , to_char(date_base,'FMMon')
        , to_char(date_base,'FMW')
        , to_char(date_base,'FMWW')
        , to_char(date_base,'FMIW')
        , to_char(date_base,'FMDD')
        , to_char(date_base,'FMD')
        , to_char(date_base,'FMID')
        , to_char(date_base,'FMDay')
        , to_char(date_base,'FMDy')
        , to_char(date_base,'FMDDD')
        , to_char(date_base,'FMIDDD')
      );
      date_base := date_base + INTERVAL '1 DAY';
    END LOOP;
    -- 
    UPDATE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".var SET var_value = date_target WHERE var_id = 'Dim Date. Next Date';
    RETURN TRUE;
  END;
$$ LANGUAGE plpgsql;

-- d_session_update function
CREATE OR REPLACE FUNCTION "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_session_update(varchar,varchar,varchar) RETURNS BOOLEAN AS $$
  -- (d_session_id <-- $1 , d_session_type <-- $2, d_session_username <-- $3)
  DECLARE
    func_session_id varchar;
  BEGIN
    -- @todo: documentar de forma adecuada
    UPDATE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_session SET d_session_active = FALSE
      WHERE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_session.d_session_username = $3
      AND   "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_session.d_session_active IS TRUE
      RETURNING "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_session.d_session_id INTO func_session_id;
    -- @todo: documentar de forma adecuada
    IF FOUND THEN
      UPDATE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_session SET state = 'Abandoned'
        WHERE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_session.session_id = func_session_id;
    END IF;
    -- @todo: documentar de forma adecuada
    INSERT INTO "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_session VALUES (
        $1
      , $2
      , $3
      , TRUE
    );
    RETURN TRUE;
  END;
$$ LANGUAGE plpgsql;

-- dw_update function
CREATE OR REPLACE FUNCTION "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".dw_update() RETURNS TRIGGER AS $$
  BEGIN
    CASE 
      WHEN NEW.message_type = 'session_start' THEN
        PERFORM "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date_update(NEW.datetime_create);
        PERFORM "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_session_update(NEW.inst_id,NEW.obj_type,NEW.actor);
        INSERT INTO "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_session VALUES (
            to_number(to_char(NEW.datetime_create,'FMYYYYMMDD'),'99999999')
          , to_number(to_char(NEW.datetime_create,'FMYYYYMMDD'),'99999999')
          , to_number(to_char(NEW.datetime_create,'HH24MI'),'9999')
          , to_number(to_char(NEW.datetime_create,'HH24MI'),'9999')
          , NEW.inst_id
          , 'Start'
          , NULL
        );
        RETURN NULL;
      WHEN NEW.message_type LIKE 'session%' THEN
        UPDATE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_session SET d_session_active = FALSE
          WHERE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_session.d_session_id = NEW.inst_id;
        UPDATE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_session
          SET date_end_sk = to_number(to_char(NEW.datetime_create,'YYYYMMDD'),'99999999')
          ,   time_end_sk = to_number(to_char(NEW.datetime_create,'HH24MI'),'9999')
          ,   state       = substring(NEW.message_type from '([^_]*)$')
          ,   duration    = NEW.duration
          WHERE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_session.session_id = NEW.inst_id;
        RETURN NULL;
      WHEN NEW.message_type = 'instance_start' THEN
        INSERT INTO "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_instance VALUES (
            NEW.message_name
          , NEW.obj_type
          , NEW.job_id
          , substring(NEW.obj_id from '(^.*)\.')
          , substring(NEW.obj_id from '([^.]*)$')
          , NEW.message_text_value
        );
        INSERT INTO "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_instance VALUES (
            to_number(to_char(NEW.datetime_create,'FMYYYYMMDD'),'99999999')
          , to_number(to_char(NEW.datetime_create,'FMYYYYMMDD'),'99999999')
          , to_number(to_char(NEW.datetime_create,'HH24MI'),'9999')
          , to_number(to_char(NEW.datetime_create,'HH24MI'),'9999')
          , NEW.inst_id
          , NEW.message_name
          , 'Start'
          , NULL
        );
        IF NEW.obj_type IN (
              'pt.webdetails.cdf.dd.DashboardDesignerContentGenerator'
            , 'org.pentaho.platform.engine.services.solution.SolutionEngine'
            , 'org.pentaho.reporting.platform.plugin.ReportContentGenerator'
            ) THEN
          INSERT INTO "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_elements VALUES (
              to_number(to_char(NEW.datetime_create,'FMYYYYMMDD'),'99999999')
            , to_number(to_char(NEW.datetime_create,'FMYYYYMMDD'),'99999999')
            , to_number(to_char(NEW.datetime_create,'HH24MI'),'9999')
            , to_number(to_char(NEW.datetime_create,'HH24MI'),'9999')
            , NEW.inst_id
            , NEW.message_name
            , 'Start'
          );
        END IF;
        RETURN NULL;
      WHEN NEW.message_type LIKE 'instance%' THEN
        UPDATE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_instance
          SET date_end_sk = to_number(to_char(NEW.datetime_create,'YYYYMMDD'),'99999999')
          ,   time_end_sk = to_number(to_char(NEW.datetime_create,'HH24MI'),'9999')
          ,   state       = substring(NEW.message_type from '([^_]*)$')
          ,   duration    = NEW.duration
          WHERE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_instance.instance_id = NEW.message_name;
        IF NEW.obj_type IN (
              'pt.webdetails.cdf.dd.DashboardDesignerContentGenerator'
            , 'org.pentaho.platform.engine.services.solution.SolutionEngine'
            , 'org.pentaho.reporting.platform.plugin.ReportContentGenerator'
            ) THEN
            UPDATE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_elements
              SET date_end_sk = to_number(to_char(NEW.datetime_create,'YYYYMMDD'),'99999999')
              ,   time_end_sk = to_number(to_char(NEW.datetime_create,'HH24MI'),'9999')
              ,   state       = substring(NEW.message_type from '([^_]*)$')
              WHERE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_elements.instance_id = NEW.message_name;
        END IF;
        RETURN NULL;
      WHEN NEW.message_type LIKE 'component%' THEN
        INSERT INTO "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_component VALUES (
            to_number(to_char(NEW.datetime_create - INTERVAL '1 seconds' * NEW.duration,'FMYYYYMMDD'),'99999999')
          , to_number(to_char(NEW.datetime_create,'YYYYMMDD'),'99999999')
          , to_number(to_char(NEW.datetime_create - INTERVAL '1 seconds' * NEW.duration,'HH24MI'),'9999')
          , to_number(to_char(NEW.datetime_create,'HH24MI'),'9999')
          , NEW.inst_id
          , NEW.obj_type -- @todo: este valor entra en conflicto con la dimension component
          , NEW.actor
          , NEW.message_name
          , NEW.obj_type
          , NEW.job_id
          , NEW.obj_id
          , NEW.message_text_value
          , NEW.obj_type -- @todo: este valor entra en conflicto con la dimension session
          , substring(NEW.message_type from '%#"(start|end)#"' for '#')
          , NEW.duration
        );
        RETURN NULL;
      ELSE
        RETURN NULL;
    END CASE;
    RETURN NULL;
  END;
$$ LANGUAGE plpgsql;

-- dw_update trigger
CREATE TRIGGER dw_update
AFTER INSERT ON "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".audit
  FOR EACH ROW EXECUTE PROCEDURE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".dw_update();

-- fill dw with some data
-- fill d_time table
SELECT "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_time_update();

ALTER SCHEMA "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>" OWNER TO "<%= ENV['PENTAHO_AUDIT_DATABASE_USER'] %>";
ALTER TABLE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".var OWNER TO "<%= ENV['PENTAHO_AUDIT_DATABASE_USER'] %>";
ALTER TABLE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".audit OWNER TO "<%= ENV['PENTAHO_AUDIT_DATABASE_USER'] %>";
ALTER TABLE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_time OWNER TO "<%= ENV['PENTAHO_AUDIT_DATABASE_USER'] %>";
ALTER TABLE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_date OWNER TO "<%= ENV['PENTAHO_AUDIT_DATABASE_USER'] %>";
ALTER TABLE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_session OWNER TO "<%= ENV['PENTAHO_AUDIT_DATABASE_USER'] %>";
ALTER TABLE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".d_instance OWNER TO "<%= ENV['PENTAHO_AUDIT_DATABASE_USER'] %>";
ALTER TABLE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_session OWNER TO "<%= ENV['PENTAHO_AUDIT_DATABASE_USER'] %>";
ALTER TABLE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_instance OWNER TO "<%= ENV['PENTAHO_AUDIT_DATABASE_USER'] %>";
ALTER TABLE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_elements OWNER TO "<%= ENV['PENTAHO_AUDIT_DATABASE_USER'] %>";
ALTER TABLE "<%= ENV['PENTAHO_AUDIT_DATABASE_SCHEMA'] %>".f_component OWNER TO "<%= ENV['PENTAHO_AUDIT_DATABASE_USER'] %>";

COMMIT;